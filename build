#! /usr/bin/env bash

set -euf -o pipefail

if [ "$#" -ne 1 ]; then
    echo "Usage: bild [debug | release | honly ]"
    exit 1
fi



cflags_global="-std=c99 -Wall -g -Wno-format-extra-args"
cflags_release="$cflags_global -O3 -DNDEBUG"
cflags_debug="$cflags_global -Werror -pedantic"
CC=clang

deps="example.c debug.c influx-writer.c inih/ini.c"
out="example"

honly_file=influx-writer-headeronly.h
honly_guard="INFLUX_WRITER_HEADERONLY_H_"



if [ "$1" = "honly" ]; then
    commit_id=$(git log --format="%H" -n 1 || true)
    date=$(date)

    echo -e "/*Autogenerated on $date from influx-writer commit ID: $commit_id*/\n\n" > $honly_file
    echo -e "#ifndef $honly_guard\n#define $honly_guard\n\n" >> $honly_file
    echo -e "#define _POSIX_C_SOURCE  200809L\n#define _GNU_SOURCE\n\n" >> $honly_file

    cat debug.h influx-writer.h debug.c influx-writer.c >> $honly_file
    echo -e "#endif /*$honly_guard*/\n" >> $honly_file

    set -x
    $CC -o influx-writer-headeronly.test $cflags_release influx-writer-headeronly.h
    rm influx-writer-headeronly.test
    exit 0 
fi


if [ "$1" = "debug" ]; then
    flags=$cflags_debug
else
    flags=$cflags_release
fi

set -x
$CC -o $out $deps $flags
